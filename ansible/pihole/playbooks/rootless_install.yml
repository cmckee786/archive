---
# v 1.1.0
# Authored by Christian McKee - cmckee786@github.com
# Implements podman pihole container with a rootless service account
#
# Requires Podman >=4.4, firewalld
#
# Tested on:
# Operating System: Rocky Linux 9.7 (Blue Onyx)
# CPE OS Name: cpe:/o:rocky:rocky:9::baseos
# Kernel: Linux 6.1.31-v8.1.el9.altarch
# Instruction Set: ARMv8-A
# Architecture: arm64
# SELinux: Disabled


- name: Setup system user, dependencies for rootless pihole, and deploy
  hosts: # Desired hosts
  gather_facts: false
  become: true
  vars:
    pihole_user: piholeserviceacc
  vars_files:
    - files/secrets.yml

  tasks:
    - name: Install dependencies and create system user
      ansible.builtin.package:
        name:
          - podman
          - firewalld
        state: present

    # Password field is taken in as a hash value. Ideally an ansible var from
    # Ansible vault or other secret tool is used here
    - name: Create system user for podman
      ansible.builtin.user:
        name: "{{ pihole_user }}"
        password: "{{ pihole_user_pass }}"
        state: present
        system: true

    - name: Enable linger for pihole service account
      ansible.builtin.command: loginctl enable-linger piholeserviceacc
      args:
        creates: /var/lib/systemd/linger/piholeserviceacc

    - name: Ensure /etc/subuid and /etc/subgid files exist
      ansible.builtin.file:
        path: "/etc/{{ item }}"
        state: touch
        mode: '0644'
      loop:
        - subuid
        - subgid

    - name: Add subuid entry for the user
      ansible.builtin.lineinfile:
        path: /etc/subuid
        regexp: "^{{ pihole_user }}:"
        line: "{{ pihole_user }}:100000:65536"
        state: present

    - name: Add subgid entry for the user
      ansible.builtin.lineinfile:
        path: /etc/subgid
        regexp: "^{{ pihole_user }}:"
        line: "{{ pihole_user }}:100000:65536"
        state: present
      register: lineinfile

    - name: Create necessary rootless directories
      ansible.builtin.file:
        path: /home/piholeserviceacc/.config/containers/systemd/
        state: directory
        owner: "{{ pihole_user }}"
        group: "{{ pihole_user }}"
        mode: '0750'

    - name: Create configuration file from template
      ansible.builtin.template:
        src: files/pihole_container.j2
        dest: /home/piholeserviceacc/.config/containers/systemd/pihole.container
        mode: '0600'
      become: true
      become_user: "{{ pihole_user }}"

    - name: Copy over quadlets to remote host
      ansible.builtin.copy:
        src: "{{ item }}"
        dest: /home/piholeserviceacc/.config/containers/systemd/
        owner: "{{ pihole_user }}"
        group: "{{ pihole_user }}"
        mode: '0750'
      with_fileglob:
        - quadlets/*

    - name: Pull images to service account
      containers.podman.podman_image:
        name: "{{ item.image }}"
        state: present
      loop:
        - image: docker.io/pihole/pihole:latest
        - image: docker.io/cloudflare/cloudflared:latest
      become_user: "{{ pihole_user }}"
      become: true

    - name: Implement sub(g)uid changes if necessary
      ansible.builtin.command: podman system migrate
      become_user: "{{ pihole_user }}"
      become: true
      when: lineinfile.changed

    - name: Redirect host ports to container ports with Rich Rules
      ansible.posix.firewalld:
        rich_rule: "{{ item.rich_rule }}"
        zone: public
        permanent: true
        immediate: true
        state: enabled
      loop:
        - rich_rule: rule family=ipv4 forward-port port=80 protocol=tcp to-port=8080
        - rich_rule: rule family=ipv4 forward-port port=443 protocol=tcp to-port=8443
        - rich_rule: rule family=ipv4 forward-port port=53 protocol=tcp to-port=10053
        - rich_rule: rule family=ipv4 forward-port port=53 protocol=udp to-port=10053

    # Quadlet [Install] section should persist these service units
    - name: Start podman via service units
      ansible.builtin.systemd:
        name: pihole_rootless-pod
        state: started
        daemon_reload: true
        scope: user
      become_user: "{{ pihole_user }}"
      become: true
